function AnalysisScene(e){var t=document.createElement("canvas"),n=t.getContext("2d"),a=new PIXI.CanvasRenderer(config.canvasWidth,config.canvasHeight,{view:t});a.render(e),this.analysis=function(e,t){for(var a=n.getImageData(t.position.x,t.position.y,e.get("speedX")+Math.sign(e.get("speedX")+1e-4),e.get("speedY")+Math.sign(e.get("speedY")+1e-4)).data,i=0,s=a.length;i<s;i+=4)a[i]===config.roadEndColor[0]&&a[i+1]===config.roadEndColor[1]&&a[i+2]===config.roadEndColor[2]&&e.stop();return e}}function MainScene(e){function t(e){e<config.stages.length?l.push(new Atlas(config.stages[e].urlXML,config.stages[e].urlIMG,function(){t(e+1)})):l.push(new Atlas(config.cars.urlXML,config.cars.urlIMG,function(){n()}))}function n(){function e(){requestAnimationFrame(e),i(),TWEEN.update(),t.render(n)}var t=new PIXI.CanvasRenderer(config.canvasWidth,config.canvasHeight,{view:$(config.canvasEl)[0]});document.body.appendChild(t.view);var n=a();e()}function a(){function e(e,t){for(var n,a=new PIXI.Container,i=0;i<e.map.length;i++)for(var s=0;s<e.map[i].length;s++)n=new PIXI.Sprite(t.getTexture(e.map[i][s][0])),n.position.x=e.map[i][s][1],n.position.y=e.map[i][s][2],n.rotation=e.map[i][s][3],n.scale.x=e.map[i][s][4],n.scale.y=e.map[i][s][5],a.addChild(n);return a}for(var t=new PIXI.Stage,n=0;n<config.stages.length;n++)t.addChild(e(config.stages[n],l[n])),config.stagesNumber===n&&(s=new AnalysisScene(t));return r=new PIXI.Text("",{font:"200px Arial",fill:"MidnightBlue"}),r.position.x=config.canvasWidth/2,r.position.y=config.canvasHeight/2,r.alpha=0,r.anchor.x=.5,r.anchor.y=.5,h.addChild(r),o=new PIXI.Sprite(l[config.stages.length].getTexture(config.cars.intro.img)),o.position.x=config.cars.intro.beginX,o.position.y=config.cars.intro.beginY,o.rotation=config.cars.intro.imgRotation,o.alpha=0,o.anchor.x=.5,o.anchor.y=.5,h.addChild(o),t.addChild(h),t}function i(){for(var t,n,a,i=0;i<c.length;i++){if(c[i].rotation=e.at(i).get("imgRotation")+e.at(i).get("rotation"),t=s.analysis(e.at(i),c[i]),c[i].position.x=c[i].position.x+t.get("speedX"),c[i].position.y=c[i].position.y+t.get("speedY"),0===e.at(i).get("endTime")){if(config.roadCheckPoints[e.at(i).get("checkPointNumber")][0]<c[i].position.x&&config.roadCheckPoints[e.at(i).get("checkPointNumber")][2]>c[i].position.x&&config.roadCheckPoints[e.at(i).get("checkPointNumber")][1]<c[i].position.y&&config.roadCheckPoints[e.at(i).get("checkPointNumber")][3]>c[i].position.y)if(a=e.at(i).get("checkPointNumber")+1,a>=config.roadCheckPoints.length){e.at(i).set({endTime:Date.now()});var o={n:i,width:c[i].width,height:c[i].height,alpha:1};new TWEEN.Tween(o).to({width:3*o.width,height:3*o.height,alpha:0},500).onUpdate(function(){c[this.n].width=this.width,c[this.n].height=this.height,c[this.n].alpha=this.alpha}).onComplete(function(){if(0===e.countCarsInRace()){var t=e.getFastestCarNumber(),n={n:t,x:g[t].position.x,y:g[t].position.y,width:g[t].width,height:g[t].height,anchorX:0,anchorY:0};new TWEEN.Tween(n).to({x:config.canvasWidth/2,y:config.canvasHeight/2,width:3*n.width,height:3*n.height,anchorX:.5,anchorY:.5},500).onUpdate(function(){g[t].position.x=this.x,g[t].position.y=this.y,g[t].width=this.width,g[t].height=this.height,g[t].anchor.x=this.anchorX,g[t].anchor.y=this.anchorY}).start()}}).start()}else e.at(i).set({checkPointNumber:a});n=Date.now()}else n=e.at(i).get("endTime");g[i].text=e.at(i).get("name")+": "+(n-e.at(i).get("beginTime"))/1e3+"s"}}var s,o,r,c=[],g=[],l=[],h=new PIXI.Container;t(0),this.beginRace=function(t,n){function a(){var t;e.each(function(e){t=new PIXI.Text("",{font:"40px Arial",fill:"Gold"}),t.position.y=40*g.length,g.push(t),h.addChild(t),e.setDefaults(),t=new PIXI.Sprite(l[config.stages.length].getTexture(e.get("img"))),t.position.x=e.get("beginX"),t.position.y=e.get("beginY"),t.rotation=e.get("imgRotation")+e.get("rotation"),t.alpha=1,t.anchor.x=.5,t.anchor.y=.5,c.push(t),h.addChild(t)})}this.breakRace(),r.text="3";var i={alpha:1};new TWEEN.Tween(i).to({alpha:0},1e3).onUpdate(function(){r.alpha=this.alpha}).onComplete(function(){r.text="2";var e={alpha:1};new TWEEN.Tween(e).to({alpha:0},1e3).onUpdate(function(){r.alpha=this.alpha}).onComplete(function(){r.text="1";var e={alpha:1};new TWEEN.Tween(e).to({alpha:0},1e3).onUpdate(function(){r.alpha=this.alpha}).onComplete(function(){r.text="Go!!!";var e={alpha:1};new TWEEN.Tween(e).to({alpha:0},1e3).onUpdate(function(){r.alpha=this.alpha}).onComplete(function(){var e={x:config.cars.intro.beginX,y:config.cars.intro.beginY,alpha:config.cars.intro.beginAlpha};new TWEEN.Tween(e).to({x:config.cars.intro.endX,y:config.cars.intro.endY,alpha:config.cars.intro.endAlpha},300).onUpdate(function(){o.position.x=this.x,o.position.y=this.y,o.alpha=this.alpha}).onComplete(function(){o.position.x=config.cars.intro.beginX,o.position.y=config.cars.intro.beginY,o.alpha=0,a(),t(n)}).start()}).start()}).start()}).start()}).start()},this.breakRace=function(){for(var e=0;e<c.length;e++)h.removeChild(c[e]),h.removeChild(g[e]);c=[],g=[]}}function Atlas(e,t,n){function a(){var t;window.XMLHttpRequest?t=new XMLHttpRequest:window.ActiveXObject&&(t=new ActiveXObject("Microsoft.XMLHTTP")),t.open("GET",e),t.onload=function(e){if(4==t.readyState&&200==t.status){for(var a=t.responseXML,i=a.getElementsByTagName("SubTexture"),o=0;o<i.length;o++)s[i[o].getAttribute("name")]={x:parseInt(i[o].getAttribute("x")),y:parseInt(i[o].getAttribute("y")),w:parseInt(i[o].getAttribute("width")),h:parseInt(i[o].getAttribute("height"))};n()}},t.send()}var i,s=[];if(void 0===e||""===e||void 0===t||""===t)throw new Error("Some error: {urlXML: "+e+", urlIMG: "+t+"}");i=new PIXI.BaseTexture.fromImage(t),a(),this.getAtlasValues=function(){return s},this.getTexture=function(e){if(void 0!==s[e])return new PIXI.Texture(i,new PIXI.Rectangle(s[e].x,s[e].y,s[e].w,s[e].h));throw new Error("Texture not found: {name: "+e+"}")}}function DB(){var e=openDatabase(config.db.name,config.db.version,config.db.label,config.db.size),t=new Backbone.Collection;t.on("add",function(t){e?e.transaction(function(e){e.executeSql(t.get("checkSQL"),[],null,function(e,n){e.executeSql(t.get("createSQL"),[],null,function(e,t){console.log("Query Error: "+t.message)})})}):console.log(config.db.errorDBConnectMessage)}),t.add(config.db.tables),this.selectValues=function(n,a,i,s){e.transaction(function(e){e.executeSql(t.findWhere({name:n}).get("selectSQL"),a,function(e,t){i(t,s)},function(e,t){console.log("Query Error: "+t.message)})})},this.insertValues=function(n,a){e.transaction(function(e){e.executeSql(t.findWhere({name:n}).get("insertSQL"),a,null,function(e,t){console.log("Query Error: "+t.message)})})}}function getMainView(){var e=Backbone.View.extend({el:"#main-control",db:{},collection:{},template:template("main"),events:{"click #btn-play":"play","click #btn-play2":"play2","click #btn-back":"back","click #btn-back2":"back2","click #btn-back3":"back2","click #btn-controls":"controls","click #btn-results":"results"},initialize:function(){this.collection=new СarsCollection,this.scene=new MainScene(this.collection);try{this.db=new DB}catch(e){console.log("DB Error: "+e.message)}_.bindAll(this,"on_keydown"),$(document).bind("keydown",this.on_keydown),this.listenTo(this.collection,"change:endTime",this.onChangeEndTime),this.render()},render:function(e){return this.$el.html(this.template({data:e})),this},play:function(){$(this.$el).find("#main-menu").css({animation:"scale_main_control0 1s forwards"}),$(this.$el).find("#btn-play").trigger("blur"),this.collection.setCarsInRace(1),this.scene.beginRace(function(e){$(e.$el).find("#btn-back").css({visibility:"visible"})},this)},play2:function(){$(this.$el).find("#main-menu").css({animation:"scale_main_control0 1s forwards"}),$(this.$el).find("#btn-play").trigger("blur"),this.collection.setCarsInRace(2),this.scene.beginRace(function(e){$(e.$el).find("#btn-back").css({visibility:"visible"})},this)},back:function(){$(this.$el).find("#main-menu").css({animation:"scale_main_control1 1s forwards"}),$("#btn-back").css({visibility:"hidden"}),$(this.$el).find("#btn-play").trigger("focus"),this.scene.breakRace()},back2:function(){this.template=template("main"),this.render()},controls:function(){function e(){for(var e="",t=0;t<config.cars.items.length;t++){e=e+"<ul> Car: <b>"+config.cars.items[t].name+"</b>";for(key in config.cars.items[t].controlKeys)e=e+'<li><b>"'+String.fromCharCode(key)+'"</b> - '+config.cars.items[t].controlKeys[key]+"</li>";e+="</ul>"}return e}this.template=template("controls"),this.render(e())},results:function(){try{this.db.selectValues("results",[],function(e,t){for(var n="<table><tr><th>№</th><th>Car</th><th>Time (s)</th><th>Сhronology</th></tr>",a=0;a<e.rows.length;a++)n=n+"<tr><td>"+(a+1)+"</td><td>"+e.rows.item(a).name+"</td><td>"+e.rows.item(a).result+"</td><td>"+e.rows.item(a).date_time+"<td></tr>";n+="</table>",t.template=template("results"),t.render(n)},this)}catch(e){console.log("DB Error: "+e.message)}},on_keydown:function(e){var t=this.collection.carsInRace();t.each(function(t){t.controlCar(e.keyCode||e.charCode)})},onChangeEndTime:function(e){if(0!==e.get("endTime"))try{this.db.insertValues("results",[e.get("name"),(e.get("endTime")-e.get("beginTime"))/1e3])}catch(e){console.log("DB Error: "+e.message)}}});return new e}function getConfig(){return{canvasEl:"#main-canvas",canvasAnalysisEl:"#analysis-canvas",canvasWidth:1016,canvasHeight:762,stagesNumber:0,stages:[{urlXML:"img/racing-pack/Spritesheets/spritesheet_tiles.xml",urlIMG:"img/racing-pack/Spritesheets/spritesheet_tiles.png",map:[[["land_grass11.png",0,0,0,1,1],["land_grass11.png",127,0,0,1,1],["land_grass11.png",254,0,0,1,1],["land_grass01.png",381,0,0,1,1],["land_grass09.png",508,0,0,1,1],["land_grass09.png",635,0,0,1,1],["land_grass09.png",762,0,0,1,1],["land_grass02.png",889,0,0,1,1]],[["land_grass01.png",0,127,0,1,1],["land_grass09.png",127,127,0,1,1],["land_grass09.png",254,127,0,1,1],["land_grass10.png",381,127,0,1,1],["land_grass12.png",508,127,0,1,1],["land_grass13.png",635,127,0,1,1],["land_grass14.png",762,127,0,1,1],["land_grass03.png",889,127,0,1,1]],[["land_grass05.png",0,254,0,1,1],["land_grass12.png",127,254,0,1,1],["land_grass13.png",254,254,0,1,1],["land_grass13.png",381,254,0,1,1],["land_grass07.png",508,254,0,1,1],["land_grass11.png",635,254,0,1,1],["land_grass05.png",762,254,0,1,1],["land_grass03.png",889,254,0,1,1]],[["land_grass05.png",0,381,0,1,1],["land_grass03.png",127,381,0,1,1],["land_grass11.png",254,381,0,1,1],["land_grass01.png",381,381,0,1,1],["land_grass09.png",508,381,0,1,1],["land_grass09.png",635,381,0,1,1],["land_grass10.png",762,381,0,1,1],["land_grass03.png",889,381,0,1,1]],[["land_grass05.png",0,508,0,1,1],["land_grass08.png",127,508,0,1,1],["land_grass09.png",254,508,0,1,1],["land_grass10.png",381,508,0,1,1],["land_grass12.png",508,508,0,1,1],["land_grass13.png",635,508,0,1,1],["land_grass13.png",762,508,0,1,1],["land_grass07.png",889,508,0,1,1]],[["land_grass06.png",0,635,0,1,1],["land_grass13.png",127,635,0,1,1],["land_grass13.png",254,635,0,1,1],["land_grass13.png",381,635,0,1,1],["land_grass07.png",508,635,0,1,1],["land_grass11.png",635,635,0,1,1],["land_grass11.png",762,635,0,1,1],["land_grass11.png",889,635,0,1,1]]]},{urlXML:"img/racing-pack/Spritesheets/spritesheet_objects.xml",urlIMG:"img/racing-pack/Spritesheets/spritesheet_objects.png",map:[[["skidmark_long_2.png",115,425,.1,.5,.5]],[["oil.png",75,500,0,.6,.6],["oil.png",956,380,1.7,.6,.6]],[["rock2.png",130,120,0,1,1],["rock1.png",390,320,0,1,1],["rock3.png",920,0,.1,1,1],["rock2.png",944,34,0,1,1],["rock2.png",50,675,1,1,1]],[["barrier_red_race.png",590,370,-.05,1,1],["barrier_red.png",710,590,-.02,1,1]],[["tent_blue.png",640,225,-.1,1,1]],[["barrel_red_down.png",340,60,.1,1,1],["barrel_red.png",280,60,0,1,1],["barrel_red.png",305,5,0,1,1],["barrel_blue.png",365,7,0,1,1],["barrel_blue_down.png",85,707,.1,1,1],["barrel_blue.png",155,707,0,1,1]],[["tree_small.png",0,50,0,1,1],["tree_small.png",130,5,0,1,1],["tree_small.png",300,420,0,1,1],["tree_small.png",870,623,0,1,1],["tree_small.png",641,559,.7,1,1]],[["tree_large.png",207,314,.1,1,1]],[["arrow_white.png",112,380,0,.2,.2],["arrow_white.png",907,320,-3.14,.2,.2]],[["barrier_white.png",385,705,-1.59,.64,.2]]]}],cars:{urlXML:"img/racing-pack/Spritesheets/spritesheet_vehicles.xml",urlIMG:"img/racing-pack/Spritesheets/spritesheet_vehicles.png",defaultCar:0,items:[{name:"BMW",img:"car_black_small_5.png",imgRotation:1.57,maxSpeed:3,minSpeed:-1,beginX:445,beginY:617,beginRotation:-3.14,controlKeys:{87:"up",83:"down",90:"stop",65:"left",68:"right"}},{name:"KIA",img:"car_red_small_2.png",imgRotation:1.57,maxSpeed:4,minSpeed:-1,beginX:445,beginY:662,beginRotation:-3.14,controlKeys:{73:"up",75:"down",77:"stop",74:"left",76:"right"}}],intro:{img:"car_green_1.png",imgRotation:1.57,beginAlpha:1,beginX:1016,beginY:381,endX:0,endY:381,endAlpha:0}},roadEndColor:[47,192,108],roadCheckPoints:[[50,370,200,412],[407,180,454,330],[818,307,965,353],[616,432,662,585],[360,562,400,710]],db:{name:"carsDB",label:"The best results of the races",version:"0.1",size:5242880,errorDBConnectMessage:"Failed to connect to database",tables:[{name:"results",createSQL:"CREATE TABLE results (id INTEGER primary key autoincrement, name TEXT, result REAL, date_time DATETIME DEFAULT (DATETIME(CURRENT_TIMESTAMP, 'LOCALTIME')))",checkSQL:"SELECT COUNT(*) FROM results",insertSQL:"INSERT INTO results (name, result) values(?, ?)",selectSQL:"SELECT * FROM results ORDER BY result, id DESC LIMIT 10"}]}}}var Car=Backbone.Model.extend({defaults:{name:"carname",img:"car_red_small_2.png",imgRotation:1.57,maxSpeed:5,minSpeed:-1,rotation:0,speed:0,speedX:0,speedY:0,beginX:0,beginY:0,beginRotation:0,beginTime:0,endTime:0,checkPointNumber:0,controlKeys:{w:"up",s:"down",z:"stop",a:"left",d:"right"}},validate:function(e){e.speed>e.maxSpeed||e.speed<e.minSpeed},controlCar:function(e){switch(this.get("controlKeys")[e]){case"up":this.speedUp();break;case"down":this.speedDown();break;case"stop":this.stop();break;case"left":this.moveLeft();break;case"right":this.moveRight()}},calculateSpeedXY:function(){var e=Math.sin(this.get("rotation"))*this.get("speed");this.set({speedX:Math.sign(Math.sin(this.get("rotation")+Math.PI/2)+1e-4)*Math.sign(this.get("speed"))*Math.sqrt(Math.pow(this.get("speed"),2)-Math.pow(e,2)),speedY:e})},speedUp:function(){this.set({speed:this.get("speed")+.3},{validate:!0}),this.calculateSpeedXY()},speedDown:function(){this.set({speed:this.get("speed")-.3},{validate:!0}),this.calculateSpeedXY()},stop:function(){this.set({speed:0}),this.calculateSpeedXY()},setDefaults:function(){this.set({speed:0,rotation:this.get("beginRotation"),checkPointNumber:0,beginTime:Date.now(),endTime:0}),this.calculateSpeedXY()},moveLeft:function(){this.set({rotation:this.get("rotation")-.2*Math.sign(this.get("speed")+1e-4)}),this.calculateSpeedXY()},moveRight:function(){this.set({rotation:this.get("rotation")+.2*Math.sign(this.get("speed")+1e-4)}),this.calculateSpeedXY()}}),СarsCollection=Backbone.Collection.extend({model:Car,carsInRace:function(){return filtered=this.filter(function(e){return 0===e.get("endTime")}),new СarsCollection(filtered)},countCarsInRace:function(){return this.where({endTime:0}).length},getFastestCarNumber:function(){var e,t=-1,n=9999999999999,a=0;return this.each(function(i){e=i.get("endTime"),0!==e&&n>e&&(n=e,t=a),a++}),t},setCarsInRace:function(e){this.reset();for(var t=0;t<e;t++)this.add(config.cars.items[t])}}),app=app||{},config=getConfig(),template=function(e){return _.template($("#"+e).html())};$(function(){app.view=getMainView()});